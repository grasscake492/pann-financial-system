import{hi as _e,r as p,hl as S,hI as F,f as W,hn as fe,ho as r,hp as ye,hq as e,hs as u,ht as _,hS as N,hr as d,hU as w,hu as g,hJ as T,hK as D,hv as o,b as G,hy as m,hV as j,hW as ge,g3 as n,g4 as H}from"./index-DmjI61J4.js";import{P as ke}from"./PageBackground2-DIHdH8cQ.js";import{a as xe,d as Ce,b as we}from"./royalty-Nces9iCc.js";import{r as Ue,u as X,a as Ie}from"./feedback-CqbHsbEQ.js";import{F as Se,a as $e}from"./feedbackStatus-DqnZOqTf.js";import"./Navbar-h4UJXtjf.js";const he={class:"tab-buttons"},Ve={key:0},Fe={class:"query-form"},Ne={class:"task-table"},Te={key:0},De=["onClick"],Ae=["onClick"],Le={key:1},Me={class:"feedback-filter"},Be={class:"feedback-item-list"},Ee={key:0,class:"empty-tip"},qe={class:"feedback-header"},Re={class:"feedback-id"},Pe={class:"feedback-content"},ze={class:"feedback-actions"},Ke=["onClick"],je=["onClick"],Ye={key:0,class:"pagination"},Je=["disabled"],Oe=["disabled"],Qe={key:1,class:"dialog-mask"},We={class:"dialog-content"},Ge={key:2,class:"dialog-mask"},He={class:"dialog-content"},Xe={key:2},Ze={class:"manage-form"},et={class:"form-item"},tt={class:"form-item"},st={class:"form-item"},lt={class:"radio-group"},at={class:"radio-item"},nt={class:"radio-item"},ot={class:"radio-item"},rt={class:"form-item"},ut={class:"form-item"},it=["value"],dt={key:0,class:"executor-list"},ct={class:"executor-header"},pt={class:"executor-tags"},mt={class:"amount-text"},vt=["onClick"],bt={class:"total-amount"},_t={class:"total-value"},ft={__name:"ManageCenter",setup(yt){const f=p("query"),A=async l=>{switch(f.value=l,l){case"query":await $();break;case"feedback":await z();break;case"manage":await K();break}},y=S({month:"",article_title:""}),L=p([]),$=async()=>{try{const l=new Date().getFullYear(),t={statistical_month:y.month?`${l}-${y.month.padStart(2,"0")}`:"",article_title:y.article_title},s=await xe(t);s.res_code==="0000"?L.value=s.data?.list||[]:n.error(`获取任务列表失败：${s.res_msg}`)}catch{n.error("网络异常，获取任务列表失败")}},Z=(l={})=>{a.record_id=l.record_id||"",a.article_title=l.article_title||"",a.created_at=l.created_at||"",a.executors=l.real_names&&l.fee_amount?l.real_names.map((t,s)=>({real_name:t,amount:l.fee_amount/l.real_names.length||0})):[],f.value="manage"},ee=async l=>{try{await H.confirm("确定要删除该任务吗？","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await Ce(l);t.res_code==="0000"?(n.success("删除成功"),await $()):n.error(`删除失败：${t.res_msg}`)}catch(t){t!=="cancel"&&n.error("网络异常，删除失败")}},h=p([]),v=p(1),M=p(2),k=p(""),x=p(""),B=S({page:1,size:100,status:""}),E=p(!1),b=p(""),C=S({reply_content:""}),q=p(!1),U=S({status:"pending"}),R=F(()=>{let l=[...h.value];if(k.value&&(l=l.filter(i=>i.created_at?.split("-")[1]===k.value.padStart(2,"0"))),x.value){const i=x.value.trim().toLowerCase();l=l.filter(I=>I.real_name?.toLowerCase().includes(i))}const t=(v.value-1)*M.value,s=t+M.value;return l.slice(t,s)}),P=F(()=>{let l=[...h.value];if(k.value&&(l=l.filter(t=>t.created_at?.split("-")[1]===k.value.padStart(2,"0"))),x.value){const t=x.value.trim().toLowerCase();l=l.filter(s=>s.real_name?.toLowerCase().includes(t))}return Math.ceil(l.length/M.value)||1}),z=async()=>{try{const l=await Ie(B);l.res_code==="0000"?(h.value=l.data.list||[],v.value=1):n.error(`查询反馈失败：${l.res_msg}`)}catch{n.error("网络异常，查询反馈失败")}},te=()=>{v.value=1},Y=l=>{l<1||l>P.value||(v.value=l)},se=l=>{b.value=l,C.reply_content="",E.value=!0},J=()=>{E.value=!1,b.value="",C.reply_content=""},le=async()=>{if(!C.reply_content.trim()){n.warning("请输入回复内容");return}try{const l=await Ue(b.value,{reply_content:C.reply_content});l.res_code==="0000"?(n.success("回复成功"),J(),await X(b.value,{status:"replied"}),await z()):n.error(`回复失败：${l.res_msg}`)}catch{n.error("网络异常，回复失败")}},ae=l=>{b.value=l;const t=h.value.find(s=>s.feedback_id===l);t&&(U.status=t.status||"pending"),q.value=!0},O=()=>{q.value=!1,b.value="",U.status="pending"},ne=async()=>{try{const l=await X(b.value,{status:U.status});l.res_code==="0000"?(n.success("状态更新成功"),O(),await z()):n.error(`状态更新失败：${l.res_msg}`)}catch{n.error("网络异常，状态更新失败")}},V=p([]),a=S({record_id:"",article_title:"",created_at:"",selectUserId:"",inputAmount:"",inputStudentNumber:"",executors:[]}),oe=F(()=>a.executors.reduce((l,t)=>l+Number(t.amount),0));F(()=>formatDepartment(Number(a.departmentId)));const K=async()=>{try{const l=await ge({page:1,size:999});l.res_code==="0000"?V.value=l.data.list||[]:n.error(`加载用户列表失败：${l.res_msg}`)}catch{n.error("网络异常，加载用户列表失败")}},re=()=>{if(!a.selectUserId){a.inputStudentNumber="";return}const l=V.value.find(t=>t.user_id===a.selectUserId);l&&l.student_number?a.inputStudentNumber=l.student_number:(a.inputStudentNumber="",n.warning("该执行人暂无学号信息，请联系管理员补充"))},ue=()=>{if(!a.selectUserId||!a.inputAmount){n.warning("请选择执行人和输入金额");return}const l=Number(a.inputAmount);if(l<=0){n.warning("金额必须大于0");return}const t=V.value.find(i=>i.user_id===a.selectUserId);if(!t){n.warning("选择的执行人不存在");return}if(a.executors.some(i=>i.user_id===t.user_id)){n.warning("该执行人已添加，请勿重复添加");return}a.executors.push({user_id:t.user_id,real_name:t.real_name,student_number:a.inputStudentNumber,amount:l}),a.selectUserId="",a.inputStudentNumber="",a.inputAmount=""},ie=l=>{a.executors.splice(l,1)},de=()=>{a.executors.length!==0&&H.confirm("确定要清空所有执行人吗？","清空确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{a.executors=[]})},ce=async()=>{if(!a.departmentId){n.warning("请选择所属部门");return}if(!a.article_title||!a.created_at){n.warning("请填写任务名称和日期");return}if(a.executors.length===0){n.warning("请添加至少一个执行人");return}const l=a.executors.map(c=>c.real_name),t=a.executors.map(c=>Number(c.user_id)),s=a.executors.map(c=>c.student_number),i=a.executors.reduce((c,be)=>c+Number(be.amount),0),[I,me]=a.created_at.split("-"),ve=`${I}-${me}`,Q={record_id:a.record_id||"",article_title:a.article_title,created_at:a.created_at,statistical_month:ve,real_names:l,user_id:t,student_numbers:s,article_type:a.articleType,fee_amount:i,department_id:Number(a.departmentId),executor_amounts:a.executors.map(c=>c.amount)};try{console.log("提交参数：",Q);const c=await we(Q);c.res_code==="0000"?(n.success(a.record_id?"编辑任务成功":"新建任务成功"),pe()):n.error(`${a.record_id?"编辑":"新建"}任务失败：${c.res_msg}`)}catch(c){n.error(`网络异常，${a.record_id?"编辑":"新建"}任务失败`),console.error("提交任务报错：",c)}},pe=()=>{Object.assign(a,{record_id:"",article_title:"",created_at:"",articleType:"",departmentId:"1",selectUserId:"",inputStudentNumber:"",inputAmount:"",executors:[]})};return W(()=>{K()}),W(async()=>{await $(),await K()}),(l,t)=>(r(),fe(ke,null,{"card-content":ye(()=>[e("div",he,[e("button",{class:N(["tab-btn",{active:f.value==="query"}]),onClick:t[0]||(t[0]=s=>A("query"))}," 任务查询 ",2),e("button",{class:N(["tab-btn",{active:f.value==="feedback"}]),onClick:t[1]||(t[1]=s=>A("feedback"))}," 反馈处理 ",2),e("button",{class:N(["tab-btn",{active:f.value==="manage"}]),onClick:t[2]||(t[2]=s=>A("manage"))}," 任务管理 ",2)]),f.value==="query"?(r(),u("div",Ve,[e("div",Fe,[t[22]||(t[22]=e("label",null,"选择月份:",-1)),d(e("select",{class:"form-select","onUpdate:modelValue":t[3]||(t[3]=s=>y.month=s)},[...t[21]||(t[21]=[e("option",{value:""},"请选择",-1),e("option",{value:"01"},"1月",-1),e("option",{value:"02"},"2月",-1),e("option",{value:"03"},"3月",-1),e("option",{value:"04"},"4月",-1),e("option",{value:"05"},"5月",-1),e("option",{value:"06"},"6月",-1),e("option",{value:"07"},"7月",-1),e("option",{value:"08"},"8月",-1),e("option",{value:"09"},"9月",-1),e("option",{value:"10"},"10月",-1),e("option",{value:"11"},"11月",-1),e("option",{value:"12"},"12月",-1)])],512),[[w,y.month]]),t[23]||(t[23]=e("label",null,"任务名称:",-1)),d(e("input",{type:"text",placeholder:"输入任务名称查询",class:"form-input","onUpdate:modelValue":t[4]||(t[4]=s=>y.article_title=s)},null,512),[[g,y.article_title]]),e("button",{class:"query-btn",onClick:$},"查询")]),e("table",Ne,[t[25]||(t[25]=e("thead",null,[e("tr",null,[e("th",null,"日期"),e("th",null,"日历图张数"),e("th",null,"参与人以及金额详情"),e("th",null,"操作")])],-1)),e("tbody",null,[L.value.length===0?(r(),u("tr",Te,[...t[24]||(t[24]=[e("td",{colspan:"4",class:"empty-tip"},"暂无任务记录",-1)])])):_("",!0),(r(!0),u(T,null,D(L.value,s=>(r(),u("tr",{key:s.record_id},[e("td",null,o(s.created_at),1),e("td",null,o(s.image_count||0),1),e("td",null,o(s.real_names?.join(", ")||"-")+" ("+o(s.fee_amount||0)+"元) ",1),e("td",null,[e("button",{class:"op-btn",onClick:i=>Z(s)},"修改",8,De),e("button",{class:"op-btn danger",onClick:i=>ee(s.record_id)},"删除",8,Ae)])]))),128))])])])):_("",!0),f.value==="feedback"?(r(),u("div",Le,[e("div",Me,[t[28]||(t[28]=e("label",null,"反馈状态:",-1)),d(e("select",{class:"form-select","onUpdate:modelValue":t[5]||(t[5]=s=>B.status=s)},[...t[26]||(t[26]=[e("option",{value:""},"全部",-1),e("option",{value:"pending"},"待处理",-1),e("option",{value:"replied"},"已回复",-1)])],512),[[w,B.status]]),t[29]||(t[29]=e("label",null,"月份:",-1)),d(e("select",{class:"form-select","onUpdate:modelValue":t[6]||(t[6]=s=>k.value=s)},[...t[27]||(t[27]=[e("option",{value:""},"全部",-1),e("option",{value:"1"},"1月",-1),e("option",{value:"2"},"2月",-1),e("option",{value:"3"},"3月",-1),e("option",{value:"4"},"4月",-1),e("option",{value:"5"},"5月",-1),e("option",{value:"6"},"6月",-1),e("option",{value:"7"},"7月",-1),e("option",{value:"8"},"8月",-1),e("option",{value:"9"},"9月",-1),e("option",{value:"10"},"10月",-1),e("option",{value:"11"},"11月",-1),e("option",{value:"12"},"12月",-1)])],512),[[w,k.value]]),t[30]||(t[30]=e("label",null,"用户姓名:",-1)),d(e("input",{type:"text",placeholder:"输入姓名模糊查询",class:"form-input","onUpdate:modelValue":t[7]||(t[7]=s=>x.value=s)},null,512),[[g,x.value]]),e("button",{class:"query-btn",onClick:te},"查询")]),e("div",Be,[R.value.length===0?(r(),u("div",Ee,"暂无反馈数据")):_("",!0),(r(!0),u(T,null,D(R.value,s=>(r(),u("div",{class:"feedback-item",key:s.feedback_id},[e("div",qe,[e("span",Re,"反馈ID："+o(s.feedback_id),1),e("span",{class:N(["status-tag",G(Se)[s.status]])},o(G($e)[s.status]),3)]),e("div",Pe,[e("p",null,[t[31]||(t[31]=e("span",{class:"label"},"反馈用户：",-1)),m(o(s.real_name),1)]),e("p",null,[t[32]||(t[32]=e("span",{class:"label"},"反馈内容：",-1)),m(o(s.content),1)]),e("p",null,[t[33]||(t[33]=e("span",{class:"label"},"反馈时间：",-1)),m(o(s.created_at),1)]),e("p",null,[t[34]||(t[34]=e("span",{class:"label"},"回复时间：",-1)),m(o(s.replied_at||"未回复"),1)]),e("p",null,[t[35]||(t[35]=e("span",{class:"label"},"回复内容：",-1)),m(o(s.reply_content||"暂无回复"),1)])]),e("div",ze,[e("button",{class:"op-btn reply-btn",onClick:i=>se(s.feedback_id)},"回复",8,Ke),e("button",{class:"op-btn status-btn",onClick:i=>ae(s.feedback_id)},"改状态",8,je)])]))),128))]),R.value.length>0?(r(),u("div",Ye,[e("button",{class:"page-btn",onClick:t[8]||(t[8]=s=>Y(v.value-1)),disabled:v.value<=1}," 上一页 ",8,Je),e("span",null,"第"+o(v.value)+"页 / 共"+o(P.value)+"页",1),e("button",{class:"page-btn",onClick:t[9]||(t[9]=s=>Y(v.value+1)),disabled:v.value>=P.value}," 下一页 ",8,Oe)])):_("",!0),E.value?(r(),u("div",Qe,[e("div",We,[e("h4",null,"回复反馈（ID: "+o(b.value)+"）",1),d(e("textarea",{placeholder:"请输入回复内容",class:"reply-textarea","onUpdate:modelValue":t[10]||(t[10]=s=>C.reply_content=s)},null,512),[[g,C.reply_content]]),e("div",{class:"dialog-btns"},[e("button",{class:"cancel-btn",onClick:J},"取消"),e("button",{class:"confirm-btn",onClick:le},"提交回复")])])])):_("",!0),q.value?(r(),u("div",Ge,[e("div",He,[e("h4",null,"更新反馈状态（ID: "+o(b.value)+"）",1),d(e("select",{class:"form-select","onUpdate:modelValue":t[11]||(t[11]=s=>U.status=s)},[...t[36]||(t[36]=[e("option",{value:"pending"},"待处理",-1),e("option",{value:"replied"},"已回复",-1)])],512),[[w,U.status]]),e("div",{class:"dialog-btns"},[e("button",{class:"cancel-btn",onClick:O},"取消"),e("button",{class:"confirm-btn",onClick:ne},"确认更新")])])])):_("",!0)])):_("",!0),f.value==="manage"?(r(),u("div",Xe,[t[50]||(t[50]=e("div",{class:"manage-title"},[e("div",{class:"title-line"}),e("h3",null,"新建任务")],-1)),e("div",Ze,[e("div",et,[t[37]||(t[37]=e("label",null,"任务名称:",-1)),d(e("input",{type:"text",placeholder:"输入",class:"form-input","onUpdate:modelValue":t[12]||(t[12]=s=>a.article_title=s)},null,512),[[g,a.article_title]])]),e("div",tt,[t[38]||(t[38]=e("label",null,"任务日期:",-1)),d(e("input",{type:"date",placeholder:"弹出日期选择框",class:"form-input","onUpdate:modelValue":t[13]||(t[13]=s=>a.created_at=s)},null,512),[[g,a.created_at]])]),e("div",st,[t[42]||(t[42]=e("label",null,"所属部门:",-1)),e("div",lt,[e("label",at,[d(e("input",{type:"radio",name:"department","onUpdate:modelValue":t[14]||(t[14]=s=>a.departmentId=s),value:"1"},null,512),[[j,a.departmentId]]),t[39]||(t[39]=m(" 新闻部 ",-1))]),e("label",nt,[d(e("input",{type:"radio",name:"department","onUpdate:modelValue":t[15]||(t[15]=s=>a.departmentId=s),value:"2"},null,512),[[j,a.departmentId]]),t[40]||(t[40]=m(" 编辑部 ",-1))]),e("label",ot,[d(e("input",{type:"radio",name:"department","onUpdate:modelValue":t[16]||(t[16]=s=>a.departmentId=s),value:"3"},null,512),[[j,a.departmentId]]),t[41]||(t[41]=m(" 运营部 ",-1))])])]),e("div",rt,[t[44]||(t[44]=e("label",null,"稿件类型:",-1)),d(e("select",{class:"form-select","onUpdate:modelValue":t[17]||(t[17]=s=>a.articleType=s)},[...t[43]||(t[43]=[e("option",{value:""},"请选择稿件类型",-1),e("option",{value:"日历图"},"日历图",-1),e("option",{value:"文案"},"文案",-1),e("option",{value:"设计"},"设计",-1)])],512),[[w,a.articleType]])]),e("div",ut,[t[46]||(t[46]=e("label",null,"执行人",-1)),d(e("select",{class:"form-select","onUpdate:modelValue":t[18]||(t[18]=s=>a.selectUserId=s),onChange:re},[t[45]||(t[45]=e("option",{value:""},"请选择执行人",-1)),(r(!0),u(T,null,D(V.value,s=>(r(),u("option",{key:s.user_id,value:s.user_id},o(s.real_name),9,it))),128))],544),[[w,a.selectUserId]]),t[47]||(t[47]=e("label",null,"学号:",-1)),d(e("input",{type:"text",class:"form-input small-input","onUpdate:modelValue":t[19]||(t[19]=s=>a.inputStudentNumber=s),readonly:"",placeholder:"选择执行人后自动填充"},null,512),[[g,a.inputStudentNumber]]),t[48]||(t[48]=e("label",null,"金额:",-1)),d(e("input",{type:"number",placeholder:"输入",class:"form-input small-input","onUpdate:modelValue":t[20]||(t[20]=s=>a.inputAmount=s),min:"0",step:"0.01"},null,512),[[g,a.inputAmount]]),e("button",{class:"add-btn",onClick:ue},"添加执行人")]),a.executors.length>0?(r(),u("div",dt,[e("div",ct,[e("label",null,"已选执行人 (共"+o(a.executors.length)+"人)",1),e("button",{class:"clear-btn",onClick:de},"清空")]),e("div",pt,[(r(!0),u(T,null,D(a.executors,(s,i)=>(r(),u("span",{key:i,class:"executor-tag"},[m(o(s.real_name)+" ",1),e("span",mt,"("+o(s.amount.toFixed(2))+"元)",1),e("button",{class:"tag-close",onClick:I=>ie(i)},"×",8,vt)]))),128))]),e("div",bt,[t[49]||(t[49]=m(" 执行人总金额: ",-1)),e("span",_t,o(oe.value.toFixed(2))+"元",1)])])):_("",!0),e("button",{class:"submit-btn",onClick:ce},"提交任务")])])):_("",!0)]),_:1}))}},It=_e(ft,[["__scopeId","data-v-0b94bc33"]]);export{It as default};
