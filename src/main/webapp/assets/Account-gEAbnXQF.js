import{hi as Q,hj as Y,hz as G,r as g,hl as N,hI as H,f as J,hB as W,g3 as t,hN as C,hO as U,hn as X,ho as k,hp as i,hx as l,hq as n,hs as R,hv as V,b as u,bl as F,bR as x,bS as w,c1 as c,$ as I,hy as y,hE as S,hP as $,hQ as ee}from"./index-CAl9Fkbs.js";import{P as se}from"./PageBackground2-Ck1v3nqa.js";import{N as ae}from"./Navbar-kC0yHLwy.js";import{c as re}from"./auth-CrLz4hq2.js";const le={key:0,class:"loading-tip"},oe={key:1,class:"empty-tip"},te={key:2,class:"info-list"},ne={class:"info-item"},ue={class:"info-value"},ie={class:"info-item"},de={class:"info-value"},me={class:"info-item"},pe={class:"info-value"},fe={class:"info-item"},ge={class:"info-value"},we={class:"info-item"},ce={class:"info-value"},q="pannfmis2025",_e={__name:"Account",setup(ve){const p=Y(),f=G(),o=g(null),_=g(!1),v=g(!1),h=g(null),d=N({oldPassword:"",newPassword:"",confirmNewPwd:""}),b=g(!1),E=g(null),r=N({real_name:"",student_number:"",email:""}),B=H(()=>{const a=f.userInfo.department_name||"";switch(f.userRole){case"super_admin":return`${a||""}管理员`;case"news_admin":return"新闻部管理员";case"editorial_admin":return"编辑部管理员";case"operation_admin":return"运营部管理员";case"normal_user":return"普通用户";default:return"未知用户"}}),A={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{pattern:/^(?=.*\d)(?=.*[a-zA-Z]).{8,16}$/,message:"新密码需8-16位，包含字母和数字",trigger:"blur"}],confirmNewPwd:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(a,e,s)=>{e!==d.newPassword?s(new Error("两次密码输入不一致")):s()},trigger:"blur"}]},z={real_name:[{required:!0,message:"请输入真实姓名",trigger:"blur"},{pattern:/^[\u4e00-\u9fa5]{2,4}$/,message:"姓名需2-4位中文",trigger:"blur"}],student_number:[{required:!0,message:"请输入学号",trigger:"blur"},{pattern:/^[0-9]{12}$/,message:"学号需12位数字",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{pattern:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,message:"邮箱格式不正确",trigger:"blur"}]};J(async()=>{try{const a=W();if(console.log("当前token：",a),!a){t.warning("请先登录"),await p.push({path:"/login"});return}_.value=!0;const e=f.userInfo?.user_id;if(!e){t.warning("用户信息不完整，请重新登录"),await p.push("/login"),_.value=!1;return}const s=await C(e);if(s.res_code!=="0000"){t.error(s.res_msg||"获取用户信息失败"),o.value=null,_.value=!1;return}const m=s.data;o.value=m||{},f.setUserInfo(m),o.value&&(r.real_name=o.value.real_name||"",r.student_number=o.value.student_number||"",r.email=o.value.email||"")}catch(a){console.error("获取用户信息失败：",a),o.value=null,a.response?.status===401?(t.error("登录已过期，请重新登录"),U(),await p.push("/login")):a.response?.status===404?t.error("用户信息不存在"):t.error("获取个人信息失败，请刷新重试")}finally{_.value=!1}});const T=()=>{U(),p.push({path:"/login"})},Z=()=>{v.value=!0},L=()=>{h.value?.resetFields(),d.oldPassword="",d.newPassword="",d.confirmNewPwd=""},M=async()=>{try{await h.value.validate();const a=f.userInfo.user_id;if(!a){t.error("用户身份失效，请重新登录");return}const e=(d.oldPassword||"")+(d.newPassword||"")+q,s=S(e),m={old_password:$(d.oldPassword),new_password:$(d.newPassword),sign:s},P=await re(a,m);P.res_code==="0000"?(t.success("密码修改成功，请重新登录"),v.value=!1,U(),await p.push("/login")):t.error(P.res_msg||"修改密码失败")}catch(a){console.error("修改密码失败：",a),a.response?.data?.res_msg?t.error(a.response.data.res_msg):a.name==="ValidationError"?t.error("表单填写有误，请检查"):t.error("修改密码失败，请稍后重试")}},j=()=>{b.value=!0},K=()=>{E.value?.resetFields(),o.value&&(r.real_name=o.value?.real_name||"",r.student_number=o.value?.student_number||"",r.email=o.value?.email||"")},O=async()=>{try{await E.value.validate();const a=(r.real_name||"")+(r.student_number||"")+(r.email||"")+q,e=S(a),s={real_name:r.real_name,student_number:r.student_number,email:r.email,sign:e},m=f.userInfo.user_id;if(!m){t.error("用户ID为空，无法修改信息"),await p.push("/login");return}const P=await ee(m,s);if(P.res_code==="0000"){t.success("信息修改成功"),b.value=!1;const D=(await C(m)).data||[];o.value=D,f.setUserInfo(D),r.real_name=o.value.real_name||"",r.student_number=o.value.student_number||"",r.email=o.value.email||""}else t.error(P.res_msg||"修改信息失败")}catch(a){console.error("修改信息失败：",a),a.response?.data?.res_msg?t.error(a.response.data.res_msg):a.name==="ValidationError"?t.error("表单填写有误，请检查：学号为12位数字、邮箱格式正确"):a.message.includes("404")?t.error("用户信息接口不存在，请检查接口路径"):a.message.includes("401")?(t.error("登录已过期，请重新登录"),await p.push("/login")):t.error("修改信息失败，请稍后重试")}};return(a,e)=>(k(),X(se,null,{"page-title":i(()=>[...e[10]||(e[10]=[y("个人信息",-1)])]),"card-content":i(()=>[_.value?(k(),R("div",le,"加载中...")):o.value?(k(),R("div",te,[n("div",ne,[e[11]||(e[11]=n("span",{class:"info-label"},"姓名：",-1)),n("span",ue,V(o.value.real_name||"未填写"),1)]),n("div",ie,[e[12]||(e[12]=n("span",{class:"info-label"},"学号：",-1)),n("span",de,V(o.value.student_number||"未填写"),1)]),n("div",me,[e[13]||(e[13]=n("span",{class:"info-label"},"邮箱：",-1)),n("span",pe,V(o.value.email||"未填写"),1)]),n("div",fe,[e[14]||(e[14]=n("span",{class:"info-label"},"用户ID：",-1)),n("span",ge,V(o.value.user_id||"未知"),1)]),n("div",we,[e[15]||(e[15]=n("span",{class:"info-label"},"部门：",-1)),n("span",ce,V(B.value),1)])])):(k(),R("div",oe," 获取个人信息失败，请刷新重试 ")),n("div",{class:"button-group"},[n("button",{class:"btn",onClick:Z},"修改密码"),n("button",{class:"btn",onClick:j},"修改信息"),n("button",{class:"btn",onClick:T},"退出登录")]),l(u(F),{modelValue:v.value,"onUpdate:modelValue":e[4]||(e[4]=s=>v.value=s),title:"修改密码",width:"400px",onClose:L},{footer:i(()=>[l(u(I),{onClick:e[3]||(e[3]=s=>v.value=!1)},{default:i(()=>[...e[16]||(e[16]=[y("取消",-1)])]),_:1}),l(u(I),{type:"primary",onClick:M},{default:i(()=>[...e[17]||(e[17]=[y("确认修改",-1)])]),_:1})]),default:i(()=>[l(u(x),{ref_key:"pwdFormRef",ref:h,model:d,rules:A,"label-width":"100px"},{default:i(()=>[l(u(w),{label:"原密码",prop:"oldPassword"},{default:i(()=>[l(u(c),{modelValue:d.oldPassword,"onUpdate:modelValue":e[0]||(e[0]=s=>d.oldPassword=s),type:"password",placeholder:"请输入原密码"},null,8,["modelValue"])]),_:1}),l(u(w),{label:"新密码",prop:"newPassword"},{default:i(()=>[l(u(c),{modelValue:d.newPassword,"onUpdate:modelValue":e[1]||(e[1]=s=>d.newPassword=s),type:"password",placeholder:"请输入新密码"},null,8,["modelValue"])]),_:1}),l(u(w),{label:"确认新密码",prop:"confirmNewPwd"},{default:i(()=>[l(u(c),{modelValue:d.confirmNewPwd,"onUpdate:modelValue":e[2]||(e[2]=s=>d.confirmNewPwd=s),type:"password",placeholder:"请确认新密码"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(u(F),{modelValue:b.value,"onUpdate:modelValue":e[9]||(e[9]=s=>b.value=s),title:"修改个人信息",width:"400px",onClose:K},{footer:i(()=>[l(u(I),{onClick:e[8]||(e[8]=s=>b.value=!1)},{default:i(()=>[...e[18]||(e[18]=[y("取消",-1)])]),_:1}),l(u(I),{type:"primary",onClick:O},{default:i(()=>[...e[19]||(e[19]=[y("确认修改",-1)])]),_:1})]),default:i(()=>[l(u(x),{ref_key:"infoFormRef",ref:E,model:r,rules:z,"label-width":"100px"},{default:i(()=>[l(u(w),{label:"真实姓名",prop:"real_name"},{default:i(()=>[l(u(c),{modelValue:r.real_name,"onUpdate:modelValue":e[5]||(e[5]=s=>r.real_name=s),placeholder:"请输入真实姓名"},null,8,["modelValue"])]),_:1}),l(u(w),{label:"学号",prop:"student_number"},{default:i(()=>[l(u(c),{modelValue:r.student_number,"onUpdate:modelValue":e[6]||(e[6]=s=>r.student_number=s),placeholder:"请输入学号"},null,8,["modelValue"])]),_:1}),l(u(w),{label:"邮箱",prop:"email"},{default:i(()=>[l(u(c),{modelValue:r.email,"onUpdate:modelValue":e[7]||(e[7]=s=>r.email=s),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),default:i(()=>[l(ae,{style:{"background-color":"transparent!important"}}),e[20]||(e[20]=n("div",{class:"title-line"},null,-1))]),_:1}))}},Ie=Q(_e,[["__scopeId","data-v-c6cac44a"]]);export{Ie as default};
