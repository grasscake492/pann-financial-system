import{aB as Y,e as g,t as D,f as j,n as H,b as J,o as k,M as u,V as n,G as o,F,S as b,u as i,R as V}from"./vue-Bt10MVH5.js";import{P as O}from"./PageBackground2-DLBYLWUD.js";import{N as Q}from"./Navbar-CY2pEkqo.js";import{h5 as W,h6 as X,h8 as ee,fS as t,hd as N,he as U,b9 as x,bF as S,bG as P,bR as y,P as I,hb as h,hf as se}from"./index-BWnjimtD.js";import{c as ae}from"./auth-x_l3GMB4.js";import"./crypto-DOZa04kq.js";const re={key:0,class:"loading-tip"},le={key:1,class:"empty-tip"},oe={key:2,class:"info-list"},te={class:"info-item"},ne={class:"info-value"},ue={class:"info-item"},ie={class:"info-value"},de={class:"info-item"},me={class:"info-value"},fe={class:"info-item"},pe={class:"info-value"},ge={class:"info-item"},ce={class:"info-value"},B="pannfmis2025",we={__name:"Account",setup(_e){const f=Y(),p=X(),l=g(null),c=g(!1),w=g(!1),R=g(null),d=D({oldPassword:"",newPassword:"",confirmNewPwd:""}),_=g(!1),E=g(null),r=D({real_name:"",student_number:"",email:""}),$=j(()=>{const s=p.userInfo.department_name||"";switch(p.userRole){case"super_admin":return`${s||"无"}`;case"news_admin":return"新闻部";case"editorial_admin":return"编辑部";case"operation_admin":return"运营部";case"normal_user":return"无";default:return"未知用户"}}),A={newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{pattern:/^(?=.*\d)(?=.*[a-zA-Z]).{8,16}$/,message:"新密码需8-16位，包含字母和数字",trigger:"blur"}],confirmNewPwd:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(s,e,a)=>{e!==d.newPassword?a(new Error("两次密码输入不一致")):a()},trigger:"blur"}]},q={real_name:[{required:!0,message:"请输入真实姓名",trigger:"blur"},{pattern:/^[\u4e00-\u9fa5]{2,}$/,message:"姓名需至少2位中文",trigger:"blur"}],student_number:[{required:!0,message:"请输入学号",trigger:"blur"},{pattern:/^[0-9]{12}$/,message:"学号需12位数字",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{pattern:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,message:"邮箱格式不正确",trigger:"blur"}]};H(async()=>{try{const s=ee();if(console.log("当前token：",s),!s){t.warning("请先登录"),await f.push({path:"/login"});return}c.value=!0;const e=p.userInfo?.user_id;if(!e){t.warning("用户信息不完整，请重新登录"),await f.push("/login"),c.value=!1;return}const a=await N(e);if(a.res_code!=="0000"){t.error(a.res_msg||"获取用户信息失败"),l.value=null,c.value=!1;return}const m=a.data;l.value=m||{},p.setUserInfo(m),l.value&&(r.real_name=l.value.real_name||"",r.student_number=l.value.student_number||"",r.email=l.value.email||"")}catch(s){console.error("获取用户信息失败：",s),l.value=null,s.response?.status===401?(t.error("登录已过期，请重新登录"),U(),await f.push("/login")):s.response?.status===404?t.error("用户信息不存在"):t.error("获取个人信息失败，请刷新重试")}finally{c.value=!1}});const z=()=>{U(),f.push({path:"/login"})},T=()=>{w.value=!0},Z=()=>{R.value?.resetFields(),d.oldPassword="",d.newPassword="",d.confirmNewPwd=""},L=async()=>{try{await R.value.validate();const s=p.userInfo.user_id;if(!s){t.error("用户身份失效，请重新登录");return}const e=(d.oldPassword||"")+(d.newPassword||"")+B,a=h(e),m={new_password:d.newPassword,sign:a},v=await ae(s,m);v.res_code==="0000"?(t.success("密码修改成功，请重新登录"),w.value=!1,U(),await f.push("/login")):t.error(v.res_msg||"修改密码失败")}catch(s){console.error("修改密码失败：",s),s.response?.data?.res_msg?t.error(s.response.data.res_msg):s.name==="ValidationError"?t.error("表单填写有误，请检查"):t.error("修改密码失败，请稍后重试")}},M=()=>{_.value=!0},G=()=>{E.value?.resetFields(),l.value&&(r.real_name=l.value?.real_name||"",r.student_number=l.value?.student_number||"",r.email=l.value?.email||"")},K=async()=>{try{await E.value.validate();const s=(r.real_name||"")+(r.student_number||"")+(r.email||"")+B,e=h(s),a={real_name:r.real_name,student_number:r.student_number,email:r.email,sign:e},m=p.userInfo.user_id;if(!m){t.error("用户ID为空，无法修改信息"),await f.push("/login");return}const v=await se(m,a);if(v.res_code==="0000"){t.success("信息修改成功"),_.value=!1;const C=(await N(m)).data||[];l.value=C,p.setUserInfo(C),r.real_name=l.value.real_name||"",r.student_number=l.value.student_number||"",r.email=l.value.email||""}else t.error(v.res_msg||"修改信息失败")}catch(s){console.error("修改信息失败：",s),s.response?.data?.res_msg?t.error(s.response.data.res_msg):s.name==="ValidationError"?t.error("表单填写有误，请检查：学号为12位数字、邮箱格式正确"):s.message.includes("404")?t.error("用户信息接口不存在，请检查接口路径"):s.message.includes("401")?(t.error("登录已过期，请重新登录"),await f.push("/login")):t.error("修改信息失败，请稍后重试")}};return(s,e)=>(k(),J(O,null,{"page-title":u(()=>[...e[9]||(e[9]=[V("个人信息",-1)])]),"card-content":u(()=>[c.value?(k(),F("div",re,"加载中...")):l.value?(k(),F("div",oe,[o("div",te,[e[10]||(e[10]=o("span",{class:"info-label"},"姓名：",-1)),o("span",ne,b(l.value.real_name||"未填写"),1)]),o("div",ue,[e[11]||(e[11]=o("span",{class:"info-label"},"学号：",-1)),o("span",ie,b(l.value.student_number||"未填写"),1)]),o("div",de,[e[12]||(e[12]=o("span",{class:"info-label"},"邮箱：",-1)),o("span",me,b(l.value.email||"未填写"),1)]),o("div",fe,[e[13]||(e[13]=o("span",{class:"info-label"},"用户ID：",-1)),o("span",pe,b(l.value.user_id||"未知"),1)]),o("div",ge,[e[14]||(e[14]=o("span",{class:"info-label"},"部门：",-1)),o("span",ce,b($.value),1)])])):(k(),F("div",le," 获取个人信息失败，请刷新重试 ")),o("div",{class:"button-group"},[o("button",{class:"btn",onClick:T},"修改密码"),o("button",{class:"btn",onClick:M},"修改信息"),o("button",{class:"btn",onClick:z},"退出登录")]),n(i(x),{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=a=>w.value=a),title:"修改密码",width:"400px",onClose:Z},{footer:u(()=>[n(i(I),{onClick:e[2]||(e[2]=a=>w.value=!1)},{default:u(()=>[...e[15]||(e[15]=[V("取消",-1)])]),_:1}),n(i(I),{type:"primary",onClick:L},{default:u(()=>[...e[16]||(e[16]=[V("确认修改",-1)])]),_:1})]),default:u(()=>[n(i(S),{ref_key:"pwdFormRef",ref:R,model:d,rules:A,"label-width":"100px"},{default:u(()=>[n(i(P),{label:"新密码",prop:"newPassword"},{default:u(()=>[n(i(y),{modelValue:d.newPassword,"onUpdate:modelValue":e[0]||(e[0]=a=>d.newPassword=a),type:"password",placeholder:"请输入新密码"},null,8,["modelValue"])]),_:1}),n(i(P),{label:"确认新密码",prop:"confirmNewPwd"},{default:u(()=>[n(i(y),{modelValue:d.confirmNewPwd,"onUpdate:modelValue":e[1]||(e[1]=a=>d.confirmNewPwd=a),type:"password",placeholder:"请确认新密码"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),n(i(x),{modelValue:_.value,"onUpdate:modelValue":e[8]||(e[8]=a=>_.value=a),title:"修改个人信息",width:"400px",onClose:G},{footer:u(()=>[n(i(I),{onClick:e[7]||(e[7]=a=>_.value=!1)},{default:u(()=>[...e[17]||(e[17]=[V("取消",-1)])]),_:1}),n(i(I),{type:"primary",onClick:K},{default:u(()=>[...e[18]||(e[18]=[V("确认修改",-1)])]),_:1})]),default:u(()=>[n(i(S),{ref_key:"infoFormRef",ref:E,model:r,rules:q,"label-width":"100px"},{default:u(()=>[n(i(P),{label:"真实姓名",prop:"real_name"},{default:u(()=>[n(i(y),{modelValue:r.real_name,"onUpdate:modelValue":e[4]||(e[4]=a=>r.real_name=a),placeholder:"请输入真实姓名"},null,8,["modelValue"])]),_:1}),n(i(P),{label:"学号",prop:"student_number"},{default:u(()=>[n(i(y),{modelValue:r.student_number,"onUpdate:modelValue":e[5]||(e[5]=a=>r.student_number=a),placeholder:"请输入学号"},null,8,["modelValue"])]),_:1}),n(i(P),{label:"邮箱",prop:"email"},{default:u(()=>[n(i(y),{modelValue:r.email,"onUpdate:modelValue":e[6]||(e[6]=a=>r.email=a),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),default:u(()=>[n(Q,{style:{"background-color":"transparent!important"}}),e[19]||(e[19]=o("div",{class:"title-line"},null,-1))]),_:1}))}},Re=W(we,[["__scopeId","data-v-98fd397f"]]);export{Re as default};
