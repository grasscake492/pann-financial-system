import{P as S}from"./PageBackground-B-fVelI8.js";import{N as v,g as p}from"./Navbar-CY2pEkqo.js";import{h6 as w,hc as A,fS as D}from"./index-BWnjimtD.js";import{u as N}from"./notice-D1oFNx-S.js";import{aB as b,e as P,f,n as B,b as I,o as s,M as x,V as M,G as l,F as a,S as u,U as R,a9 as U}from"./vue-Bt10MVH5.js";import"./crypto-DOZa04kq.js";import"./announcement-p87uQSgg.js";import"./feedback-CSX88a8d.js";const F={class:"home-content"},L={key:0,class:"loading-tip"},V={key:1},$={class:"welcome-text"},z={class:"notice-section"},C={key:0,class:"notice-list"},E={key:1,class:"empty-notice"},Q={__name:"Home",setup(T){const g=b(),d=P(!0),n=w(),r=N(),_=f(()=>n.userInfo.real_name||"未知用户"),m=f(()=>r.announcementList.filter(e=>e.published_at).sort((e,t)=>new Date(t.published_at)-new Date(e.published_at)).slice(0,3)),h=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},k=async()=>{try{const e=A();if(!e){window.location.href="/login";return}if(n.userInfo&&n.userInfo.token&&n.userInfo.real_name){console.log("【首页】已有完整用户信息，跳过用户信息拉取，仅拉取公告");const c=await r.fetchAllAnnouncements({sign:p({timestamp:Date.now()}),pageNum:1,pageSize:10});c&&c.res_code==="0000"&&r.setAnnouncements(c.data.records||c.data),d.value=!1;return}const t=p({timestamp:Date.now()}),[o,i]=await Promise.all([n.loadUserProfile({sign:t,token:e}),r.fetchAllAnnouncements({sign:t,pageNum:1,pageSize:10})]);o&&o.res_code==="0000"&&n.setUserInfo(o.data),i&&i.res_code==="0000"&&r.setAnnouncements(i.data.records||i.data)}catch(e){console.error("首页数据请求失败：",e),alert("数据加载失败，请刷新页面重试")}finally{d.value=!1}},y=()=>{try{const t=n.isSuperAdmin||n.isDeptAdmin?"/admin/announcement":"/user/announcement";g.push(t)}catch(e){console.error("跳转公告页面失败：",e),D.error("页面跳转失败，请重试")}};return B(async()=>{await k()}),(e,t)=>(s(),I(S,null,{default:x(()=>[M(v,{style:{"background-color":"transparent!important"}}),l("div",F,[d.value?(s(),a("div",L,"加载中...")):(s(),a("div",V,[l("h2",$,"欢迎，"+u(_.value),1),l("div",z,[t[0]||(t[0]=l("h3",{class:"notice-title"},"最新公告",-1)),m.value.length>0?(s(),a("ul",C,[(s(!0),a(R,null,U(m.value,o=>(s(),a("li",{key:o.announcement_id,class:"notice-item",onClick:y,style:{cursor:"pointer"}}," ["+u(h(o.published_at))+"] "+u(o.title)+"："+u(o.content),1))),128))])):(s(),a("div",E,"暂无最新公告"))])]))])]),_:1}))}};export{Q as default};
