import{P as w}from"./PageBackground-YvUIJ2ow.js";import{N as v,g as h}from"./Navbar-Cp1G5LLH.js";import{hi as A,r as S,hy as D,hH as p,f as N,hm as P,hn as o,ho as b,hw as I,hp as l,hr as a,hu as u,hI as B,hJ as x,hK as R,g2 as L}from"./index-C7oC9Sm-.js";import{u as M}from"./notice-Dn4Wf4C9.js";import"./announcement-DemJwFUU.js";import"./feedback-DEOOQuX0.js";const U={class:"home-content"},$={key:0,class:"loading-tip"},z={key:1},C={class:"welcome-text"},E={class:"notice-section"},F={key:0,class:"notice-list"},H={key:1,class:"empty-notice"},G={__name:"Home",setup(T){const g=A(),d=S(!0),n=D(),r=M(),_=p(()=>n.userInfo.real_name||"未知用户"),m=p(()=>r.announcementList.filter(e=>e.published_at).sort((e,t)=>new Date(t.published_at)-new Date(e.published_at)).slice(0,3)),f=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},y=async()=>{try{const e=R();if(!e){window.location.href="/login";return}if(n.userInfo&&n.userInfo.token&&n.userInfo.real_name){console.log("【首页】已有完整用户信息，跳过用户信息拉取，仅拉取公告");const c=await r.fetchAllAnnouncements({sign:h({timestamp:Date.now()}),pageNum:1,pageSize:10});c&&c.res_code==="0000"&&r.setAnnouncements(c.data.records||c.data),d.value=!1;return}const t=h({timestamp:Date.now()}),[s,i]=await Promise.all([n.loadUserProfile({sign:t,token:e}),r.fetchAllAnnouncements({sign:t,pageNum:1,pageSize:10})]);s&&s.res_code==="0000"&&n.setUserInfo(s.data),i&&i.res_code==="0000"&&r.setAnnouncements(i.data.records||i.data)}catch(e){console.error("首页数据请求失败：",e),alert("数据加载失败，请刷新页面重试")}finally{d.value=!1}},k=()=>{try{const t=n.isSuperAdmin||n.isDeptAdmin?"/admin/announcement":"/user/announcement";g.push(t)}catch(e){console.error("跳转公告页面失败：",e),L.error("页面跳转失败，请重试")}};return N(async()=>{await y()}),(e,t)=>(o(),P(w,null,{default:b(()=>[I(v,{style:{"background-color":"transparent!important"}}),l("div",U,[d.value?(o(),a("div",$,"加载中...")):(o(),a("div",z,[l("h2",C,"欢迎，"+u(_.value),1),l("div",E,[t[0]||(t[0]=l("h3",{class:"notice-title"},"最新公告",-1)),m.value.length>0?(o(),a("ul",F,[(o(!0),a(B,null,x(m.value,s=>(o(),a("li",{key:s.announcement_id,class:"notice-item",onClick:k,style:{cursor:"pointer"}}," ["+u(f(s.published_at))+"] "+u(s.title)+"："+u(s.content),1))),128))])):(o(),a("div",H,"暂无最新公告"))])]))])]),_:1}))}};export{G as default};
