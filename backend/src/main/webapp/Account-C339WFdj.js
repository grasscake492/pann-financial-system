import{hi as Q,hj as Y,hz as G,r as g,hl as N,hI as H,f as J,hB as W,g3 as o,hN as C,hO as R,hn as X,ho as h,hp as u,hx as n,hq as t,hs as U,hv as b,b as i,bl as F,bR as x,bS as P,c1 as V,$ as k,hy as y,hE as S,hP as $,hQ as ee}from"./index-CRrSqBSg.js";import{P as se}from"./PageBackground2-CY7PUuwQ.js";import{N as ae}from"./Navbar-DqK1H5Mm.js";import{c as re}from"./auth-C86FJw8D.js";const le={key:0,class:"loading-tip"},oe={key:1,class:"empty-tip"},te={key:2,class:"info-list"},ne={class:"info-item"},ue={class:"info-value"},ie={class:"info-item"},de={class:"info-value"},me={class:"info-item"},fe={class:"info-value"},pe={class:"info-item"},ge={class:"info-value"},ce={class:"info-item"},we={class:"info-value"},B="pannfmis2025",_e={__name:"Account",setup(ve){const f=Y(),p=G(),l=g(null),c=g(!1),w=g(!1),I=g(null),d=N({oldPassword:"",newPassword:"",confirmNewPwd:""}),_=g(!1),E=g(null),r=N({real_name:"",student_number:"",email:""}),q=H(()=>{const s=p.userInfo.department_name||"";switch(p.userRole){case"super_admin":return`${s||"无"}`;case"news_admin":return"新闻部";case"editorial_admin":return"编辑部";case"operation_admin":return"运营部";case"normal_user":return"无";default:return"未知用户"}}),A={newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{pattern:/^(?=.*\d)(?=.*[a-zA-Z]).{8,16}$/,message:"新密码需8-16位，包含字母和数字",trigger:"blur"}],confirmNewPwd:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(s,e,a)=>{e!==d.newPassword?a(new Error("两次密码输入不一致")):a()},trigger:"blur"}]},z={real_name:[{required:!0,message:"请输入真实姓名",trigger:"blur"},{pattern:/^[\u4e00-\u9fa5]{2,}$/,message:"姓名需至少2位中文",trigger:"blur"}],student_number:[{required:!0,message:"请输入学号",trigger:"blur"},{pattern:/^[0-9]{12}$/,message:"学号需12位数字",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{pattern:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,message:"邮箱格式不正确",trigger:"blur"}]};J(async()=>{try{const s=W();if(console.log("当前token：",s),!s){o.warning("请先登录"),await f.push({path:"/login"});return}c.value=!0;const e=p.userInfo?.user_id;if(!e){o.warning("用户信息不完整，请重新登录"),await f.push("/login"),c.value=!1;return}const a=await C(e);if(a.res_code!=="0000"){o.error(a.res_msg||"获取用户信息失败"),l.value=null,c.value=!1;return}const m=a.data;l.value=m||{},p.setUserInfo(m),l.value&&(r.real_name=l.value.real_name||"",r.student_number=l.value.student_number||"",r.email=l.value.email||"")}catch(s){console.error("获取用户信息失败：",s),l.value=null,s.response?.status===401?(o.error("登录已过期，请重新登录"),R(),await f.push("/login")):s.response?.status===404?o.error("用户信息不存在"):o.error("获取个人信息失败，请刷新重试")}finally{c.value=!1}});const T=()=>{R(),f.push({path:"/login"})},Z=()=>{w.value=!0},L=()=>{I.value?.resetFields(),d.oldPassword="",d.newPassword="",d.confirmNewPwd=""},M=async()=>{try{await I.value.validate();const s=p.userInfo.user_id;if(!s){o.error("用户身份失效，请重新登录");return}const e=(d.oldPassword||"")+(d.newPassword||"")+B,a=S(e),m={old_password:$(d.oldPassword),new_password:$(d.newPassword),sign:a},v=await re(s,m);v.res_code==="0000"?(o.success("密码修改成功，请重新登录"),w.value=!1,R(),await f.push("/login")):o.error(v.res_msg||"修改密码失败")}catch(s){console.error("修改密码失败：",s),s.response?.data?.res_msg?o.error(s.response.data.res_msg):s.name==="ValidationError"?o.error("表单填写有误，请检查"):o.error("修改密码失败，请稍后重试")}},j=()=>{_.value=!0},K=()=>{E.value?.resetFields(),l.value&&(r.real_name=l.value?.real_name||"",r.student_number=l.value?.student_number||"",r.email=l.value?.email||"")},O=async()=>{try{await E.value.validate();const s=(r.real_name||"")+(r.student_number||"")+(r.email||"")+B,e=S(s),a={real_name:r.real_name,student_number:r.student_number,email:r.email,sign:e},m=p.userInfo.user_id;if(!m){o.error("用户ID为空，无法修改信息"),await f.push("/login");return}const v=await ee(m,a);if(v.res_code==="0000"){o.success("信息修改成功"),_.value=!1;const D=(await C(m)).data||[];l.value=D,p.setUserInfo(D),r.real_name=l.value.real_name||"",r.student_number=l.value.student_number||"",r.email=l.value.email||""}else o.error(v.res_msg||"修改信息失败")}catch(s){console.error("修改信息失败：",s),s.response?.data?.res_msg?o.error(s.response.data.res_msg):s.name==="ValidationError"?o.error("表单填写有误，请检查：学号为12位数字、邮箱格式正确"):s.message.includes("404")?o.error("用户信息接口不存在，请检查接口路径"):s.message.includes("401")?(o.error("登录已过期，请重新登录"),await f.push("/login")):o.error("修改信息失败，请稍后重试")}};return(s,e)=>(h(),X(se,null,{"page-title":u(()=>[...e[9]||(e[9]=[y("个人信息",-1)])]),"card-content":u(()=>[c.value?(h(),U("div",le,"加载中...")):l.value?(h(),U("div",te,[t("div",ne,[e[10]||(e[10]=t("span",{class:"info-label"},"姓名：",-1)),t("span",ue,b(l.value.real_name||"未填写"),1)]),t("div",ie,[e[11]||(e[11]=t("span",{class:"info-label"},"学号：",-1)),t("span",de,b(l.value.student_number||"未填写"),1)]),t("div",me,[e[12]||(e[12]=t("span",{class:"info-label"},"邮箱：",-1)),t("span",fe,b(l.value.email||"未填写"),1)]),t("div",pe,[e[13]||(e[13]=t("span",{class:"info-label"},"用户ID：",-1)),t("span",ge,b(l.value.user_id||"未知"),1)]),t("div",ce,[e[14]||(e[14]=t("span",{class:"info-label"},"部门：",-1)),t("span",we,b(q.value),1)])])):(h(),U("div",oe," 获取个人信息失败，请刷新重试 ")),t("div",{class:"button-group"},[t("button",{class:"btn",onClick:Z},"修改密码"),t("button",{class:"btn",onClick:j},"修改信息"),t("button",{class:"btn",onClick:T},"退出登录")]),n(i(F),{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=a=>w.value=a),title:"修改密码",width:"400px",onClose:L},{footer:u(()=>[n(i(k),{onClick:e[2]||(e[2]=a=>w.value=!1)},{default:u(()=>[...e[15]||(e[15]=[y("取消",-1)])]),_:1}),n(i(k),{type:"primary",onClick:M},{default:u(()=>[...e[16]||(e[16]=[y("确认修改",-1)])]),_:1})]),default:u(()=>[n(i(x),{ref_key:"pwdFormRef",ref:I,model:d,rules:A,"label-width":"100px"},{default:u(()=>[n(i(P),{label:"新密码",prop:"newPassword"},{default:u(()=>[n(i(V),{modelValue:d.newPassword,"onUpdate:modelValue":e[0]||(e[0]=a=>d.newPassword=a),type:"password",placeholder:"请输入新密码"},null,8,["modelValue"])]),_:1}),n(i(P),{label:"确认新密码",prop:"confirmNewPwd"},{default:u(()=>[n(i(V),{modelValue:d.confirmNewPwd,"onUpdate:modelValue":e[1]||(e[1]=a=>d.confirmNewPwd=a),type:"password",placeholder:"请确认新密码"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),n(i(F),{modelValue:_.value,"onUpdate:modelValue":e[8]||(e[8]=a=>_.value=a),title:"修改个人信息",width:"400px",onClose:K},{footer:u(()=>[n(i(k),{onClick:e[7]||(e[7]=a=>_.value=!1)},{default:u(()=>[...e[17]||(e[17]=[y("取消",-1)])]),_:1}),n(i(k),{type:"primary",onClick:O},{default:u(()=>[...e[18]||(e[18]=[y("确认修改",-1)])]),_:1})]),default:u(()=>[n(i(x),{ref_key:"infoFormRef",ref:E,model:r,rules:z,"label-width":"100px"},{default:u(()=>[n(i(P),{label:"真实姓名",prop:"real_name"},{default:u(()=>[n(i(V),{modelValue:r.real_name,"onUpdate:modelValue":e[4]||(e[4]=a=>r.real_name=a),placeholder:"请输入真实姓名"},null,8,["modelValue"])]),_:1}),n(i(P),{label:"学号",prop:"student_number"},{default:u(()=>[n(i(V),{modelValue:r.student_number,"onUpdate:modelValue":e[5]||(e[5]=a=>r.student_number=a),placeholder:"请输入学号"},null,8,["modelValue"])]),_:1}),n(i(P),{label:"邮箱",prop:"email"},{default:u(()=>[n(i(V),{modelValue:r.email,"onUpdate:modelValue":e[6]||(e[6]=a=>r.email=a),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),default:u(()=>[n(ae,{style:{"background-color":"transparent!important"}}),e[19]||(e[19]=t("div",{class:"title-line"},null,-1))]),_:1}))}},ke=Q(_e,[["__scopeId","data-v-69fa9ed0"]]);export{ke as default};
