import{P as v}from"./PageBackground-DVoZhtbM.js";import{N as w,g as h}from"./Navbar-DqK1H5Mm.js";import{hj as A,r as S,hz as D,hI as p,f as N,hn as P,ho as o,hp as b,hx as I,hq as l,hs as a,hv as u,hJ as x,hK as B,hL as L,g3 as R}from"./index-CRrSqBSg.js";import{u as z}from"./notice-BXE7xEZR.js";import"./announcement-DV9cg1hu.js";import"./feedback-CsxdGIKI.js";const M={class:"home-content"},U={key:0,class:"loading-tip"},$={key:1},C={class:"welcome-text"},E={class:"notice-section"},F={key:0,class:"notice-list"},T={key:1,class:"empty-notice"},G={__name:"Home",setup(V){const g=A(),d=S(!0),n=D(),r=z(),_=p(()=>n.userInfo.real_name||"未知用户"),m=p(()=>r.announcementList.filter(e=>e.published_at).sort((e,t)=>new Date(t.published_at)-new Date(e.published_at)).slice(0,3)),f=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},k=async()=>{try{const e=L();if(!e){window.location.href="/login";return}if(n.userInfo&&n.userInfo.token&&n.userInfo.real_name){console.log("【首页】已有完整用户信息，跳过用户信息拉取，仅拉取公告");const i=await r.fetchAllAnnouncements({sign:h({timestamp:Date.now()}),pageNum:1,pageSize:10});i&&i.res_code==="0000"&&r.setAnnouncements(i.data.records||i.data),d.value=!1;return}const t=h({timestamp:Date.now()}),[s,c]=await Promise.all([n.loadUserProfile({sign:t,token:e}),r.fetchAllAnnouncements({sign:t,pageNum:1,pageSize:10})]);s&&s.res_code==="0000"&&n.setUserInfo(s.data),c&&c.res_code==="0000"&&r.setAnnouncements(c.data.records||c.data)}catch(e){console.error("首页数据请求失败：",e),alert("数据加载失败，请刷新页面重试")}finally{d.value=!1}},y=()=>{try{const t=n.isSuperAdmin||n.isDeptAdmin?"/admin/announcement":"/user/announcement";g.push(t)}catch(e){console.error("跳转公告页面失败：",e),R.error("页面跳转失败，请重试")}};return N(async()=>{await k()}),(e,t)=>(o(),P(v,null,{default:b(()=>[I(w,{style:{"background-color":"transparent!important"}}),l("div",M,[d.value?(o(),a("div",U,"加载中...")):(o(),a("div",$,[l("h2",C,"欢迎，"+u(_.value),1),l("div",E,[t[0]||(t[0]=l("h3",{class:"notice-title"},"最新公告",-1)),m.value.length>0?(o(),a("ul",F,[(o(!0),a(x,null,B(m.value,s=>(o(),a("li",{key:s.announcement_id,class:"notice-item",onClick:y,style:{cursor:"pointer"}}," ["+u(f(s.published_at))+"] "+u(s.title)+"："+u(s.content),1))),128))])):(o(),a("div",T,"暂无最新公告"))])]))])]),_:1}))}};export{G as default};
